<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>å¥³å·«é•‡ - Witch Town</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0f0c29" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="å¥³å·«é•‡" />
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063212.png" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              witch: {
                900: '#0f0c29',
                800: '#302b63',
                700: '#24243e',
                accent: '#a8edea',
                gold: '#ffd700',
              }
            },
            fontFamily: {
              serif: ['Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
              sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif'],
              mono: ['"Courier New"', 'Courier', 'monospace'],
            },
            animation: {
              'pulse-slow': 'pulse 6s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'glow': 'glow 3s ease-in-out infinite alternate',
              'blink': 'blink 1s step-end infinite',
            },
            keyframes: {
              glow: {
                '0%': { textShadow: '0 0 10px rgba(168,85,247,0.4), 0 0 20px rgba(168,85,247,0.2)', opacity: '0.9', filter: 'brightness(1)' },
                '100%': { textShadow: '0 0 30px rgba(168,85,247,0.8), 0 0 60px rgba(168,85,247,0.5)', opacity: '1', filter: 'brightness(1.2)' },
              },
              blink: {
                '0%, 100%': { opacity: '1' },
                '50%': { opacity: '0' },
              }
            }
          }
        }
      }
    </script>

    <!-- React, ReactDOM, Babel, GSAP -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
      body {
        background-color: #0f0c29;
        color: white;
        overflow-x: hidden;
        overflow-y: auto; /* Allow scrolling if content is too tall */
        margin: 0;
        -webkit-tap-highlight-color: transparent;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.3);
      }
      ::-webkit-scrollbar-thumb {
        background: #4c1d95; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6d28d9; 
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "gsap": "https://aistudiocdn.com/gsap@^3.13.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script>
      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>

    <script type="text/babel">
      const { useState, useEffect, useRef, useLayoutEffect } = React;

      // --- Constants ---
      const GAME_URL = "http://118.31.222.7:8000/";
      
      const BULLETIN_CONTENT = `æ„Ÿè°¢å°é•‡æ”¹è‰¯å®¶ä»¬ï¼

ç‰¹åˆ«è‡´è°¢å¤å¤å…ˆç”Ÿã€è–‡è–‡å°å§ã€ææºç¦å¤§ç‹ã€ç…é¥¼å¥³å£«ã€æ˜Šæ˜Šå…ˆç”Ÿã€æ´‹ç§˜å¥³å£«ã€ç¾å¥³ä¸å°å§ã€å¹³å‡¡è€å¸ˆ â€”â€” æ˜¯ä½ ä»¬åŒ–èº« â€œbug çŒæ‰‹â€ï¼Œæ‰«æ¸…ã€Šå¥³å·«é•‡ã€‹é‡Œçš„æ½œè—éšæ‚£ï¼Œç”¨ç»†è‡´åé¦ˆä¸ºå°é•‡çš„å®Œç¾å‘ˆç°ä¿é©¾æŠ¤èˆªï¼Œç”±è¡·æ„Ÿè°¢æ¯ä¸€ä»½é¼åŠ›æ”¯æŒï¼

å°é•‡çš„è¿·é›¾ä¾æ—§å­˜åœ¨ï¼ŒæœŸå¾…æœªæ¥ç»§ç»­ä¸ä½ ä»¬ä¸€åŒæ‰“ç£¨ï¼Œè®©å°é•‡å˜å¾—æ›´åŠ ç¾å¥½ï¼`;

      const INSTALL_GUIDE = {
        ios: "1. ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨ä¸­é—´çš„åˆ†äº«æŒ‰é’®ã€‚\n2. åœ¨å¼¹å‡ºçš„èœå•ä¸­å‘ä¸‹æ»‘åŠ¨ï¼Œæ‰¾åˆ°å¹¶ç‚¹å‡»â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚\n3. ç‚¹å‡»å³ä¸Šè§’çš„â€œæ·»åŠ â€ã€‚",
        android: "1. ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„ä¸‰ä¸ªç‚¹èœå•ã€‚\n2. æ‰¾åˆ°â€œå®‰è£…åº”ç”¨â€æˆ–â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚\n3. æŒ‰ç…§æç¤ºç¡®è®¤æ·»åŠ ã€‚",
        general: "å°†ç½‘ç«™æ·»åŠ åˆ°æ¡Œé¢ï¼Œè·å¾—ç±»ä¼¼åŸç”ŸAppçš„å…¨å±æ¸¸æˆä½“éªŒã€‚"
      };

      const WECHAT_WARNING = "æ£€æµ‹åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨å¾®ä¿¡è®¿é—®ã€‚\nä¸ºäº†ä¿è¯æ¸¸æˆä½“éªŒï¼Œå»ºè®®ç‚¹å‡»å³ä¸Šè§’ä¸‰ä¸ªç‚¹ (...)ï¼Œé€‰æ‹©â€œåœ¨æµè§ˆå™¨æ‰“å¼€â€ã€‚";

      // --- Components ---

      // Background Component
      const Background = () => (
        <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none">
          <div className="absolute inset-0 bg-gradient-to-br from-[#0f0c29] via-[#302b63] to-[#24243e]"></div>
          <div className="absolute inset-0 bg-black opacity-10 mix-blend-overlay"></div>
          {/* Orbs */}
          <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-600/20 rounded-full blur-[100px] animate-pulse-slow"></div>
          <div className="absolute bottom-1/4 right-1/4 w-80 h-80 bg-blue-600/20 rounded-full blur-[80px] animate-pulse-slow delay-1000"></div>
          {/* Vignette */}
          <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.8)_100%)]"></div>
        </div>
      );

      // Modal Component
      const Modal = ({ isOpen, onClose, title, children }) => {
        const overlayRef = useRef(null);
        const contentRef = useRef(null);

        useEffect(() => {
          if (isOpen) {
            gsap.to(overlayRef.current, {
              opacity: 1,
              duration: 0.3,
              display: 'flex',
              ease: 'power2.out'
            });
            gsap.fromTo(contentRef.current, 
              { scale: 0.8, opacity: 0, y: 20 },
              { scale: 1, opacity: 1, y: 0, duration: 0.4, ease: 'back.out(1.7)' }
            );
          } else {
            gsap.to(overlayRef.current, {
              opacity: 0,
              duration: 0.2,
              display: 'none',
              ease: 'power2.in'
            });
          }
        }, [isOpen]);

        return (
          <div 
            ref={overlayRef}
            className="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4"
            onClick={onClose}
          >
            <div 
              ref={contentRef}
              className="w-full max-w-lg bg-slate-900 border border-purple-500/50 rounded-xl shadow-[0_0_30px_rgba(139,92,246,0.3)] overflow-hidden relative"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="bg-gradient-to-r from-purple-900 to-slate-900 p-4 border-b border-purple-500/30 flex justify-between items-center">
                <h2 className="text-xl font-bold text-purple-100 font-serif tracking-wide">{title}</h2>
                <button 
                  onClick={onClose}
                  className="text-purple-300 hover:text-white transition-colors text-2xl leading-none"
                >
                  &times;
                </button>
              </div>
              <div className="p-6 text-purple-100/90 leading-relaxed whitespace-pre-line max-h-[60vh] overflow-y-auto custom-scrollbar">
                {children}
              </div>
              <div className="h-1 w-full bg-gradient-to-r from-transparent via-purple-500 to-transparent opacity-50"></div>
            </div>
          </div>
        );
      };

      // OrientationGuard Component
      const OrientationGuard = ({ isLandscape, isWeChat }) => {
        const containerRef = useRef(null);
        const iconRef = useRef(null);

        useEffect(() => {
          if (!isLandscape && containerRef.current) {
            const ctx = gsap.context(() => {
              gsap.to(iconRef.current, {
                rotation: -90,
                duration: 1.5,
                repeat: -1,
                repeatDelay: 0.5,
                ease: "power2.inOut",
                yoyo: true
              });
            }, containerRef);
            return () => ctx.revert();
          }
        }, [isLandscape]);

        if (isLandscape) return null;

        return (
          <div 
            ref={containerRef}
            className="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-8 text-center"
          >
            <div className="mb-8" ref={iconRef}>
              <svg width="80" height="140" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-purple-400">
                <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                <line x1="12" y1="18" x2="12.01" y2="18"></line>
              </svg>
            </div>
            
            <h2 className="text-2xl font-bold text-white mb-4">è¯·å°†æ‰‹æœºæ¨ªå±</h2>
            <p className="text-purple-200 mb-6">ã€Šå¥³å·«é•‡ã€‹éœ€è¦æ¨ªå±æ¸¸ç©ä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚</p>

            {isWeChat && (
              <div className="bg-yellow-900/40 border border-yellow-600/50 p-4 rounded-lg max-w-sm mt-4 animate-pulse">
                 <p className="text-yellow-200 text-sm font-medium">
                   âš ï¸ å¾®ä¿¡æµè§ˆå™¨æç¤º
                 </p>
                 <p className="text-yellow-100/80 text-sm mt-1 text-left">
                   {WECHAT_WARNING}
                 </p>
              </div>
            )}
          </div>
        );
      };

      // Retro Button Component (FC Style)
      const Btn = ({ onClick, primary, children }) => (
        <button
          onClick={onClick}
          className="group relative flex items-center justify-center w-full max-w-[280px] py-1 md:py-1.5 transition-all duration-200 focus:outline-none"
        >
          {/* Retro Cursor (Left) - Visible on Hover */}
          <span className="absolute left-0 md:left-4 text-witch-gold opacity-0 group-hover:opacity-100 transition-opacity font-mono text-xl md:text-2xl animate-blink transform -translate-x-full group-hover:translate-x-0 duration-300">
            â–¶
          </span>
          
          {/* Text Content */}
          <span className={`
            font-mono text-sm md:text-lg font-bold tracking-[0.2em] uppercase
            ${primary ? 'text-witch-gold drop-shadow-[0_0_5px_rgba(255,215,0,0.5)]' : 'text-purple-300 group-hover:text-white'}
            transition-colors duration-200 group-hover:scale-105 transform
          `}>
            {children}
          </span>
          
          {/* Background Highlight (Subtle) */}
          <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 rounded scale-x-0 group-hover:scale-x-100 transition-all duration-300 ease-out origin-center -z-10"></div>
        </button>
      );

      // LandingPage Component
      const LandingPage = ({ setModal, handleInstallClick }) => {
        const containerRef = useRef(null);
        const titleRef = useRef(null);
        const buttonsRef = useRef(null);

        useLayoutEffect(() => {
          const ctx = gsap.context(() => {
            // Title fade in
            gsap.from(titleRef.current, {
              y: -30,
              opacity: 0,
              duration: 2,
              ease: "power2.out"
            });

            // List items stagger
            if (buttonsRef.current) {
              gsap.fromTo(buttonsRef.current.children, 
                { opacity: 0, x: -20 },
                {
                  opacity: 1,
                  x: 0,
                  duration: 0.5,
                  stagger: 0.15,
                  ease: "power1.out",
                  delay: 0.8
                }
              );
            }
          }, containerRef);

          return () => ctx.revert();
        }, []);

        const handleStartGame = () => {
          window.location.href = GAME_URL;
        };

        return (
          <div ref={containerRef} className="relative z-10 flex flex-col items-center justify-center min-h-screen w-full px-4 -mt-10">
            
            {/* Title Section */}
            <div className="mb-10 text-center flex flex-col items-center">
              <h1 
                ref={titleRef}
                className="text-4xl md:text-6xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-b from-purple-200 via-purple-400 to-purple-800 drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] animate-glow mb-4"
              >
                å¥³å·«é•‡
              </h1>
              <p className="text-purple-300/60 text-xs md:text-sm font-mono tracking-widest max-w-md mx-auto">
                è¿·é›¾æ•£å»ï¼Œå°é•‡è¿æ¥äº†å®ƒçš„ç¬¬ä¸€æ³¢å®¢äºº...
              </p>
            </div>

            {/* FC Menu Layout (Vertical List) */}
            <div ref={buttonsRef} className="flex flex-col items-center gap-1 w-full">
              
              <Btn onClick={handleStartGame} primary>
                å¼€å§‹æ¸¸æˆ
              </Btn>

              <Btn onClick={handleInstallClick}>
                å®‰è£…åˆ°æ¡Œé¢
              </Btn>

              <Btn onClick={() => setModal('BULLETIN')}>
                å°é•‡å‘Šç¤ºæ 
              </Btn>

            </div>
            
            <div className="absolute bottom-6 text-purple-500/20 text-[10px] font-mono tracking-widest uppercase">
              Â© 2025 Witch Town Productions
            </div>
          </div>
        );
      };

      // App Component
      const App = () => {
        const [modalType, setModalType] = useState('NONE');
        const [isLandscape, setIsLandscape] = useState(true);
        const [isWeChat, setIsWeChat] = useState(false);
        const [installPrompt, setInstallPrompt] = useState(null);

        useEffect(() => {
          // Check WeChat
          const ua = navigator.userAgent.toLowerCase();
          setIsWeChat(/micromessenger/.test(ua));

          // Check Orientation
          const checkOrientation = () => {
            const mql = window.matchMedia("(orientation: landscape)");
            const isLandscapeView = mql.matches || window.innerWidth > window.innerHeight;
            setIsLandscape(isLandscapeView);
          };

          checkOrientation();
          window.addEventListener('resize', checkOrientation);
          window.addEventListener('orientationchange', checkOrientation);

          // PWA Install Prompt Listener
          const handleBeforeInstallPrompt = (e) => {
            e.preventDefault();
            setInstallPrompt(e);
            console.log("Captured PWA install prompt event");
          };

          window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

          return () => {
            window.removeEventListener('resize', checkOrientation);
            window.removeEventListener('orientationchange', checkOrientation);
            window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
          };
        }, []);

        const closeModal = () => setModalType('NONE');

        // Intelligent Install Handler
        const handleInstallClick = () => {
          if (installPrompt) {
            installPrompt.prompt();
            installPrompt.userChoice.then((choiceResult) => {
              setInstallPrompt(null);
            });
          } else {
            setModalType('INSTALL');
          }
        };

        return (
          <div className="relative w-full h-full min-h-screen font-sans select-none">
            <Background />
            
            {/* Main Content (only visible if landscape) */}
            <div className={!isLandscape ? 'hidden' : 'block w-full'}>
              <LandingPage setModal={setModalType} handleInstallClick={handleInstallClick} />
            </div>

            {/* Orientation Guard (visible if portrait) */}
            <OrientationGuard isLandscape={isLandscape} isWeChat={isWeChat} />

            {/* Modals */}
            <Modal 
              isOpen={modalType === 'BULLETIN'} 
              onClose={closeModal} 
              title="ğŸ“œ å°é•‡å‘Šç¤ºæ "
            >
              <div className="text-lg text-justify font-serif text-purple-200">
                {BULLETIN_CONTENT}
              </div>
            </Modal>

            <Modal 
              isOpen={modalType === 'INSTALL'} 
              onClose={closeModal} 
              title="ğŸ“± å®‰è£…åˆ°æ‰‹æœºæ¡Œé¢"
            >
              <div className="space-y-6">
                <p className="text-sm text-purple-300 italic mb-4 border-b border-purple-500/30 pb-2">
                  {INSTALL_GUIDE.general}
                </p>
                
                <div className="bg-purple-900/20 p-4 rounded-lg border border-purple-500/20">
                  <h3 className="font-bold text-white mb-2 flex items-center gap-2">
                    <span className="text-xl">ğŸ</span> iOS (Safari)
                  </h3>
                  <p className="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">
                    {INSTALL_GUIDE.ios}
                  </p>
                </div>

                <div className="bg-purple-900/20 p-4 rounded-lg border border-purple-500/20">
                  <h3 className="font-bold text-white mb-2 flex items-center gap-2">
                    <span className="text-xl">ğŸ¤–</span> Android (Chrome)
                  </h3>
                  <p className="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">
                    {INSTALL_GUIDE.android}
                  </p>
                </div>
              </div>
            </Modal>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
